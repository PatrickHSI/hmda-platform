podTemplate(label: 'buildDockerContainer', containers: [
  containerTemplate(name: 'docker', image: 'docker', ttyEnabled: true, command: 'cat')],
volumes: [
  hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock'),
]) {
   node('buildDockerContainer') {
     sh "env | sort"

     def repo = checkout scm
         def gitBranch = repo.GIT_BRANCH


    stage('Build') {
      container('docker') {
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'dockerhub',
            usernameVariable: 'DOCKER_HUB_USER', passwordVariable: 'DOCKER_HUB_PASSWORD']]) {
            withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'hmda-platform-jenkins-service',
              usernameVariable: 'DTR_USER', passwordVariable: 'DTR_PASSWORD']]) {
              withCredentials([string(credentialsId: 'internal-docker-registry', variable: 'DOCKER_REGISTRY_URL')]){
              withCredentials([usernamePassword(credentialsId: 'newman-tester', passwordVariable: 'NEWMAN_PASS', usernameVariable: 'NEWMAN_USER')]) {
                sh "echo ${NEWMAN_PASS}"
                 sh "echo ${NEWMAN_USER}"
                sh "docker -v"
                sh "docker pull postman/newman;"
                sh "cd newman-tests && docker build --build-arg USER=1234 . -t trial:test -f docker/Dockerfile  --build-arg pass=${NEWMAN_PASS}"
                sh "docker run trial:test"
                }
              }
            }
          }
        }
      }
  }
}
